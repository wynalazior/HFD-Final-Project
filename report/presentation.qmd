---
title: "HFD Final Project – Group 1"
subtitle: "Opening Range Breakout Strategy and Z Trend Strategy for SP & NQ Futures"
author: "Krzysztof Nalazek, Shah"
date: "January 2026"
format:
  revealjs:
    slide-number: true
    chalkboard: false
    theme: [default, custom.scss]
    transition: slide
    background-transition: fade
    scrollable: false
    smaller: true
    fig-width: 8
    fig-height: 3.5
    fig-align: center
    incremental: false
    code-fold: false
    code-overflow: wrap
execute:
  echo: false
  warning: false
  message: false
---

## Project Setup

:::: {.columns}
::: {.column width="50%"}
**Data Specifications:**

- **Assets:** S&P 500 (SP) & NASDAQ (NQ)  
- **Frequency:** 1-minute bars
- **Period:** 2023 Q1 – 2025 Q2
- **Trading:** Separate signals, portfolio aggregation
:::

::: {.column width="50%"}
**Trading Constraints (both):**

- **Excluded windows:** 9:31–9:40, 15:51–16:00
- **No trading:** 9:31–9:55 (volatility buffer)
- **Forced flat:** 15:40 onwards
- **No overnight positions**
:::
::::

---

## Strategy Overview

:::: {.columns}
::: {.column width="50%"}
### Strategy 1: Opening Range Breakout

**Key Features:**

- Opening range: 09:41–09:55
- Breakout entry with ATR buffer
- Mean-reversion exits
- Low turnover design
:::

::: {.column width="50%"}
### Strategy 2: Z Guided Trend

**Key Features:**

- Trend-following entries (SMA vs SMA_slow level + slope gate)
- z-score entry with z-momentum confirmation (z accelerating into entry)
- Hard constraints: no-trade window, no new entries after 14:30, forced flat from 15:40
- Risk controls: z stop-loss + extreme z stop, cooldown after exits (reduces churn)
:::
<br>
::::

---

```{python}
#| include: false

# Setup: Load libraries and data
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from pathlib import Path

REPO_ROOT = Path("..")

# Load ORB results
orb_summary_path = REPO_ROOT / "Testing" / "outputs_orb_final" / "orb_final_summary.csv"
orb = pd.read_csv(orb_summary_path)
```

## Strategy 1: Opening Range Breakout (ORB)

**Core Algorithm:**

1. **Opening Range Definition** (09:41–09:55)
   - Calculate High/Low during opening period
   - Forms baseline for breakout detection

2. **Entry Logic** (after 09:55)
   - **Long**: Price > Range_High + (ATR × Multiplier)
   - **Short**: Price < Range_Low - (ATR × Multiplier)
   
3. **Exit Logic**
   - Mean reversion: Exit when price returns inside range
   - Forced flat at 15:40 (no overnight risk)

4. **Risk Controls**
   - One entry per day (prevents overtrading)
   - Volatility-adjusted thresholds (ATR)
   - Transaction cost awareness

## Strategy 02 : Z Guided Trend

**Core Algorithm:**

1. **Trend Definition**
   - Fast SMA for level
   - Slow SMA for intraday trend
   - Trend confirmed by slow SMA slope

2. **Entry and Exit Logic**
   - **Long:** Trend up + price rising + z-score increasing
   - **Short:** Trend down + price falling + z-score decreasing
   - Stop-loss when z moves against position
   - Exit if trend reverses
   - Exit at extreme z-score levels
   - Forced flat at 15:40 (no overnight)

3. **Risk Controls**
   - No trading during 09:31–09:55
   - No new entries after 14:30
   - Cooldown period after exits
   - Transaction costs included in P&L


---


## ORB: Parameter Optimization

::: {.columns}
::: {.column width="50%"}
**3-Way Data Split:**

- **Training** (4 qtrs): 2023_Q1, Q3, 2024_Q2, Q4
- **Validation** (2 qtrs): 2023_Q4, 2025_Q1  
- **Test** (1 qtr): 2025_Q2

**Grid Search:**

- **ATR Window**: [15, 30, 60] minutes
- **ATR Multiplier**: [0.0, 0.05, 0.10, 0.15, 0.20]
- **Selection**: Based on VALIDATION performance

**Optimal Parameters:**

```{python}
#| echo: true
# Best parameters (selected on validation)
print("SP: ATR_window=15, ATR_mult=0.0")
print("NQ: ATR_window=30, ATR_mult=0.2")
```
:::

::: {.column width="50%"}
**STAT Metric:**

$$\text{STAT} = (\text{Sharpe}_{\text{net}} - 0.5) \times \ln(|\text{Net PnL}/1000|)$$

- Penalizes low Sharpe ratios
- Rewards larger absolute PnL
- Balances risk-adjusted and absolute returns

**Methodology:**

1. Evaluate all combinations on TRAIN
2. Select best based on VALIDATION  
3. Final evaluation on TEST (unseen)
:::
:::

---

## Z Guided Trend: Parameter Optimization

::: {.columns}
::: {.column width="50%"}
**Train-Test Split:**

- **Training** (4 qtrs): 2023_Q1, Q3, 2024_Q2, Q4 
- **Test** (1 qtr): 2025_Q2

**Grid Search:**

- **SMA Window**: [240, 360, 480] minutes  
- **Slow Multiplier**: [3, 4]  
- **Slope Lookback (m)**: [5, 10]  
- **Z Entry Threshold**: [1.4, 1.6, 1.8, 2.0]  
- **Z Stop Threshold**: [3.5, 4.0, 4.5]  
- **Z Stop-Loss (SL) Threshold**: [1.0, 1.5, 2.0]  
- **Z Momentum Threshold**: [0.05, 0.10, 0.20, 0.30]  
- **Cooldown**: [5, 10]  
- **Selection**: Based on VALIDATION performance


**Optimal Parameters:**

```{python}
#| echo: false
import pandas as pd
from pathlib import Path

summary = pd.read_csv(Path("../Testing/outputs_strategy02") / "strategy02_summary.csv")

q = "data1_2023_Q4"

best = summary[summary["quarter"] == q].sort_values(["asset"])

for _, r in best.iterrows():
    print(
        f"{r['asset']}: SMA_win={int(r['SMA_win'])}, slow_mult={int(r['slow_mult'])}, slope_m={int(r['slope_m'])}, "
        f"z_entry={r['z_entry']}, z_stop={r['z_stop']}, z_sl={r['z_sl']}, z_mom={r['z_mom']}, cooldown={int(r['cooldown'])}"
    )

```
:::

::: {.column width="50%"}
**Optimization Objective:**

- We select parameters that maximize Net P&L (transaction costs included).
- This penalizes over-trading automatically via per-trade costs.
- Balances risk-adjusted and absolute returns

**Methodology:**

1. Evaluate all combinations on TRAIN.
2. Use same quarter combination on next year. (Seasonality)
3. Final evaluation on TEST
:::
:::

---

## ORB: Train/Validation/Test Performance

```{python}
#| fig-width: 9
#| fig-height: 4

import matplotlib.pyplot as plt
from matplotlib.image import imread

# Load and display the train/val/test comparison
img_path = REPO_ROOT / "Testing" / "outputs_orb_final" / "train_val_test.png"
if img_path.exists():
    img = imread(img_path)
    fig, ax = plt.subplots(figsize=(9, 4))
    ax.imshow(img)
    ax.axis('off')
    plt.tight_layout()
    plt.show()
else:
    print("Train/Val/Test visualization not found")
```

**Key Observations:**

- Parameters selected based on VALIDATION performance (not training)
- TEST quarter (2025_Q2) is completely unseen during optimization
- Performance degradation from train → validation → test expected
- Large gap suggests strategy may not generalize well

---

## Z Guided Trend: Train/Validation/Test Performance

```{python}
#| fig-width: 9
#| fig-height: 4
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from pathlib import Path

train_perf = pd.read_csv(Path("../Testing/outputs_strategy02/strategy02_perf.csv"))
test_perf  = pd.read_csv(Path("../Testing/outputs_strategy02/strategy02_perf_OOS.csv"))

trainp = train_perf[train_perf["asset"] == "NQ"].copy()
testp  = test_perf[test_perf["asset"] == "NQ"].copy()

if trainp.empty:
    raise ValueError("No NQ rows in strategy02_perf.csv")
if testp.empty:
    raise ValueError("No NQ rows in strategy02_perf_OOS.csv")

TRAIN_Q = ["data1_2023_Q1", "data1_2023_Q3", "data1_2024_Q2", "data1_2024_Q4"]
TEST_Q  = ["data1_2025_Q2"]

train = trainp[trainp["quarter"].isin(TRAIN_Q)]
test  = testp[testp["quarter"].isin(TEST_Q)]

train_net_pnl = float(train["net_cumPnL"].sum())
test_net_pnl  = float(test["net_cumPnL"].sum())

train_sharpe = float(np.mean(train["netSR"])) if len(train) else np.nan
test_sharpe  = float(np.mean(test["netSR"]))  if len(test)  else np.nan

labels = ["Training", "Test (OOS)"]
net_vals = [train_net_pnl, test_net_pnl]
sr_vals  = [train_sharpe, test_sharpe]

fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 3.8))

ax1.bar(labels, net_vals)
ax1.set_title("Net PnL: Train / Out-of-Sample Test")
ax1.grid(True, axis="y", alpha=0.3)

ax2.bar(labels, sr_vals)
ax2.set_title("Sharpe: Train / Out-of-Sample Test")
ax2.grid(True, axis="y", alpha=0.3)

plt.tight_layout()
plt.show()


```

**Key Observations:**

- Parameters selected based on TRAINING performance.
- TEST quarter (2025_Q2) is completely unseen during optimization.
- Performance degradation in PnL form, with modest risk adjusted resturns.

---

## ORB: Key Performance Metrics

```{python}
import matplotlib.pyplot as plt
import matplotlib.dates as mdates

# Load data
out_dir = REPO_ROOT / "Testing" / "outputs_orb_final"
daily_files = sorted(out_dir.glob("*_portfolio_daily.csv"))

daily_all = []
for fp in daily_files:
    d = pd.read_csv(fp)
    d["date"] = pd.to_datetime(d["date"])
    daily_all.append(d)

daily_all = pd.concat(daily_all).sort_values("date")
daily_all["cum_gross"] = daily_all["gross_pnl"].cumsum()
daily_all["cum_net"] = daily_all["net_pnl"].cumsum()

# Calculate metrics
total_net_pnl = daily_all["net_pnl"].sum()
sharpe = daily_all["net_pnl"].mean() / daily_all["net_pnl"].std() * np.sqrt(252)
cum_pnl = daily_all["cum_net"]
max_dd = (cum_pnl - cum_pnl.cummax()).min()
calmar = (daily_all["net_pnl"].mean() * 252) / abs(max_dd) if max_dd != 0 else np.nan
win_rate = (daily_all["net_pnl"] > 0).sum() / len(daily_all) * 100

# Display metrics
metrics_df = pd.DataFrame({
    'Metric': ['Total Net PnL', 'Annualized Sharpe', 'Annualized Calmar', 
               'Max Drawdown', 'Win Rate', 'Total Days'],
    'Value': [f'${total_net_pnl:,.2f}', f'{sharpe:.3f}', f'{calmar:.3f}',
              f'${max_dd:,.2f}', f'{win_rate:.1f}%', f'{len(daily_all)}']
})
metrics_df
```

---

## Z Trend: Key Performance Metrics
```{python}
import numpy as np
import pandas as pd
from pathlib import Path

# Quarto runs from ./report, but outputs_strategy02 is at repo root
OUT_DIR = Path("../Testing/outputs_strategy02")

daily_files = sorted(OUT_DIR.glob("*_PORTFOLIO_daily.csv"))
if not daily_files:
    raise ValueError(f"No *_PORTFOLIO_daily.csv found in {OUT_DIR}. Found: {[p.name for p in OUT_DIR.glob('*.csv')]}")
daily_all = []
for fp in daily_files:
    d = pd.read_csv(fp)
    d["date"] = pd.to_datetime(d["date"])
    daily_all.append(d[["date","gross_pnl","net_pnl","trades"]])

daily_all = pd.concat(daily_all, ignore_index=True).sort_values("date")
daily_all["cum_gross"] = daily_all["gross_pnl"].cumsum()
daily_all["cum_net"]   = daily_all["net_pnl"].cumsum()

total_net_pnl = float(daily_all["net_pnl"].sum())
sd = daily_all["net_pnl"].std(ddof=1)
sharpe = float(daily_all["net_pnl"].mean() / sd * np.sqrt(252)) if sd and np.isfinite(sd) else np.nan

cum_pnl = daily_all["cum_net"]
max_dd  = float((cum_pnl - cum_pnl.cummax()).min())
calmar  = float((daily_all["net_pnl"].mean() * 252) / abs(max_dd)) if max_dd and np.isfinite(max_dd) and max_dd != 0 else np.nan

win_rate = float((daily_all["net_pnl"] > 0).mean() * 100)
total_days = int(len(daily_all))

pd.DataFrame({
    "Metric": ["Total Net PnL", "Annualized Sharpe", "Annualized Calmar", "Max Drawdown", "Win Rate", "Total Days"],
    "Value":  [f"${total_net_pnl:,.2f}", f"{sharpe:.3f}", f"{calmar:.3f}", f"${max_dd:,.2f}", f"{win_rate:.1f}%", f"{total_days}"]
})

```


## ORB: Cumulative PnL (Portfolio)

```{python}
#| fig-width: 9
#| fig-height: 4.5

fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(9, 4.5), sharex=True)

# Cumulative PnL
ax1.plot(daily_all["date"], daily_all["cum_gross"], label="Gross PnL", linewidth=2, alpha=0.7)
ax1.plot(daily_all["date"], daily_all["cum_net"], label="Net PnL", linewidth=2)
ax1.axhline(0, color='red', linestyle='--', alpha=0.5)
ax1.set_ylabel("Cumulative PnL ($)")
ax1.set_title("Strategy 1 (ORB) – Portfolio Performance", fontweight='bold')
ax1.legend(loc='upper left')
ax1.grid(True, alpha=0.3)

# Daily PnL bars
colors = ['green' if x >= 0 else 'red' for x in daily_all["net_pnl"]]
ax2.bar(daily_all["date"], daily_all["net_pnl"], color=colors, alpha=0.6, width=0.8)
ax2.axhline(0, color='black', linestyle='-', linewidth=0.8)
ax2.set_ylabel("Daily PnL ($)")
ax2.set_xlabel("Date")
ax2.grid(True, alpha=0.3, axis='y')
ax2.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m'))

plt.tight_layout()
plt.show()
```

---

## Z Guided Trend : Cumulative PnL (Portfolio)
```{python}
#| fig-width: 9
#| fig-height: 4.5
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from pathlib import Path

BASE_DIR = Path.cwd()  # .../HFD-Final-Project/report
OUT_DIR  = BASE_DIR.parent / "Testing" / "outputs_strategy02"

daily_files = sorted(OUT_DIR.glob("data1_*_PORTFOLIO_daily.csv"))
if not daily_files:
    raise ValueError(f"No data1_*_PORTFOLIO_daily.csv files found in {OUT_DIR}. BASE_DIR={BASE_DIR}")

daily_all = []
for fp in daily_files:
    d = pd.read_csv(fp)
    d["date"] = pd.to_datetime(d["date"])
    d["quarter"] = fp.name.replace("_PORTFOLIO_daily.csv", "")
    daily_all.append(d[["date", "gross_pnl", "net_pnl", "trades", "quarter"]])

daily_all = pd.concat(daily_all, ignore_index=True).sort_values("date")
daily_all["cum_gross"] = daily_all["gross_pnl"].cumsum()
daily_all["cum_net"]   = daily_all["net_pnl"].cumsum()

fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(9, 4.5), sharex=True)

ax1.plot(daily_all["date"], daily_all["cum_gross"], label="Gross PnL", linewidth=2, alpha=0.7)
ax1.plot(daily_all["date"], daily_all["cum_net"], label="Net PnL", linewidth=2)
ax1.axhline(0, linestyle="--", alpha=0.5)
ax1.set_ylabel("Cumulative PnL ($)")
ax1.set_title("Z Guided Trend – Portfolio Performance", fontweight="bold")
ax1.legend(loc="upper left")
ax1.grid(True, alpha=0.3)

colors = np.where(daily_all["net_pnl"] >= 0, "green", "red")
ax2.bar(daily_all["date"], daily_all["net_pnl"], color=colors, alpha=0.6, width=0.8)
ax2.axhline(0, linewidth=0.8)
ax2.set_ylabel("Daily PnL ($)")
ax2.set_xlabel("Date")
ax2.grid(True, alpha=0.3, axis="y")
ax2.xaxis.set_major_formatter(mdates.DateFormatter("%Y-%m"))

plt.tight_layout()
plt.show()

```

---

## ORB: Quarterly Performance Breakdown

```{python}
#| fig-width: 9
#| fig-height: 5

orb_port = orb[orb["asset"]=="PORTFOLIO"].copy()

fig, axes = plt.subplots(2, 2, figsize=(9, 5))

# 1. Net PnL by Quarter
ax1 = axes[0, 0]
quarters = orb_port["quarter"].tolist()
net_pnls = orb_port["net_cumPnL"].tolist()
colors_bars = ['green' if x >= 0 else 'red' for x in net_pnls]
ax1.bar(range(len(quarters)), net_pnls, color=colors_bars, alpha=0.7)
ax1.set_xticks(range(len(quarters)))
ax1.set_xticklabels(quarters, rotation=45, ha='right', fontsize=8)
ax1.axhline(0, color='black', linestyle='-', linewidth=0.8)
ax1.set_title("Net PnL by Quarter", fontsize=10, fontweight='bold')
ax1.set_ylabel("Net PnL ($)", fontsize=9)
ax1.grid(True, alpha=0.3, axis='y')

# 2. Sharpe Ratio by Quarter
ax2 = axes[0, 1]
sharpes = orb_port["netSR"].tolist()
ax2.bar(range(len(quarters)), sharpes, color='steelblue', alpha=0.7)
ax2.set_xticks(range(len(quarters)))
ax2.set_xticklabels(quarters, rotation=45, ha='right', fontsize=8)
ax2.axhline(0, color='black', linestyle='-', linewidth=0.8)
ax2.set_title("Sharpe Ratio by Quarter", fontsize=10, fontweight='bold')
ax2.set_ylabel("Sharpe Ratio", fontsize=9)
ax2.grid(True, alpha=0.3, axis='y')

# 3. Calmar Ratio by Quarter  
ax3 = axes[1, 0]
calmars = orb_port["netCR"].tolist()
ax3.bar(range(len(quarters)), calmars, color='darkorange', alpha=0.7)
ax3.set_xticks(range(len(quarters)))
ax3.set_xticklabels(quarters, rotation=45, ha='right', fontsize=8)
ax3.axhline(0, color='black', linestyle='-', linewidth=0.8)
ax3.set_title("Calmar Ratio by Quarter", fontsize=10, fontweight='bold')
ax3.set_ylabel("Calmar Ratio", fontsize=9)
ax3.grid(True, alpha=0.3, axis='y')

# 4. STAT Score by Quarter
ax4 = axes[1, 1]
stats = orb_port["stat"].tolist()
ax4.bar(range(len(quarters)), stats, color='purple', alpha=0.7)
ax4.set_xticks(range(len(quarters)))
ax4.set_xticklabels(quarters, rotation=45, ha='right', fontsize=8)
ax4.axhline(0, color='black', linestyle='-', linewidth=0.8)
ax4.set_title("STAT Score by Quarter", fontsize=10, fontweight='bold')
ax4.set_ylabel("STAT Score", fontsize=9)
ax4.grid(True, alpha=0.3, axis='y')

plt.tight_layout()
plt.show()
```

---


## Z Guided Trend : Quarterly Performance Breakdown
```{python}
#| fig-width: 9
#| fig-height: 5
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from pathlib import Path

# ---- load your Z Guided TrendB perf table (PORTFOLIO rows) ----
BASE_DIR = Path.cwd()                  # report/
OUT_DIR  = BASE_DIR.parent / "Testing" / "outputs_strategy02"
perf = pd.read_csv(OUT_DIR / "strategy02_perf.csv")

s2b_port = perf[perf["asset"] == "PORTFOLIO"].copy()
s2b_port = s2b_port.sort_values("quarter")

fig, axes = plt.subplots(2, 2, figsize=(9, 5))

quarters = s2b_port["quarter"].tolist()

# 1. Net PnL by Quarter
ax1 = axes[0, 0]
net_pnls = s2b_port["net_cumPnL"].tolist()
colors_bars = ["green" if x >= 0 else "red" for x in net_pnls]
ax1.bar(range(len(quarters)), net_pnls, color=colors_bars, alpha=0.7)
ax1.set_xticks(range(len(quarters)))
ax1.set_xticklabels(quarters, rotation=45, ha="right", fontsize=8)
ax1.axhline(0, color="black", linestyle="-", linewidth=0.8)
ax1.set_title("Net PnL by Quarter", fontsize=10, fontweight="bold")
ax1.set_ylabel("Net PnL ($)", fontsize=9)
ax1.grid(True, alpha=0.3, axis="y")

# 2. Sharpe Ratio by Quarter
ax2 = axes[0, 1]
sharpes = s2b_port["netSR"].tolist()
ax2.bar(range(len(quarters)), sharpes, alpha=0.7)
ax2.set_xticks(range(len(quarters)))
ax2.set_xticklabels(quarters, rotation=45, ha="right", fontsize=8)
ax2.axhline(0, color="black", linestyle="-", linewidth=0.8)
ax2.set_title("Sharpe Ratio by Quarter", fontsize=10, fontweight="bold")
ax2.set_ylabel("Sharpe Ratio", fontsize=9)
ax2.grid(True, alpha=0.3, axis="y")

# 3. Calmar Ratio by Quarter
ax3 = axes[1, 0]
calmars = s2b_port["netCR"].tolist()
ax3.bar(range(len(quarters)), calmars, alpha=0.7)
ax3.set_xticks(range(len(quarters)))
ax3.set_xticklabels(quarters, rotation=45, ha="right", fontsize=8)
ax3.axhline(0, color="black", linestyle="-", linewidth=0.8)
ax3.set_title("Calmar Ratio by Quarter", fontsize=10, fontweight="bold")
ax3.set_ylabel("Calmar Ratio", fontsize=9)
ax3.grid(True, alpha=0.3, axis="y")

# 4. netSR 
ax4 = axes[1, 1]
netSRtype = s2b_port["netSR"].tolist()
ax4.bar(range(len(quarters)), netSRtype, alpha=0.7)
ax4.set_xticks(range(len(quarters)))
ax4.set_xticklabels(quarters, rotation=45, ha="right", fontsize=8)
ax4.axhline(0, color="black", linestyle="-", linewidth=0.8)
ax4.set_title("Sharpe (netSR) by Quarter", fontsize=10, fontweight="bold")
ax4.set_ylabel("Annualized Sharpe", fontsize=9)
ax4.grid(True, alpha=0.3, axis="y")

plt.tight_layout()
plt.show()

```

---


## ORB: Per-Asset Results

```{python}
orb_assets = orb[orb["asset"].isin(["SP","NQ"])].copy()

# Format for better readability
display_cols = ['quarter', 'asset', 'atr_window', 'atr_mult', 
                'netSR', 'netCR', 'net_cumPnL', 'av.ntrades', 'stat']
orb_display = orb_assets[display_cols].copy()
orb_display['net_cumPnL'] = orb_display['net_cumPnL'].apply(lambda x: f'${x:,.0f}')
orb_display['netSR'] = orb_display['netSR'].apply(lambda x: f'{x:.3f}')
orb_display['netCR'] = orb_display['netCR'].apply(lambda x: f'{x:.3f}')
orb_display['av.ntrades'] = orb_display['av.ntrades'].apply(lambda x: f'{x:.1f}')
orb_display['stat'] = orb_display['stat'].apply(lambda x: f'{x:.4f}')
orb_display
```

---


## Z Guided Trend: Per-Asset Results

```{python}
import pandas as pd
from pathlib import Path

# ---- load your Z Guided TrendB perf table ----
BASE_DIR = Path.cwd()                  # report/
OUT_DIR  = BASE_DIR.parent / "Testing" / "outputs_strategy02"
perf = pd.read_csv(OUT_DIR / "strategy02_perf.csv")

s2b_assets = perf[perf["asset"].isin(["SP","NQ"])].copy().sort_values(["quarter","asset"])

# Columns you actually have (no atr_window/atr_mult/stat)
display_cols = ["quarter", "asset", "netSR", "netCR", "net_cumPnL", "av.ntrades"]
s2b_display = s2b_assets[display_cols].copy()

# Format like your friend's table
s2b_display["net_cumPnL"]  = s2b_display["net_cumPnL"].apply(lambda x: f"${x:,.0f}")
s2b_display["netSR"]       = s2b_display["netSR"].apply(lambda x: f"{x:.3f}")
s2b_display["netCR"]       = s2b_display["netCR"].apply(lambda x: f"{x:.3f}")
s2b_display["av.ntrades"]  = s2b_display["av.ntrades"].apply(lambda x: f"{x:.1f}")

s2b_display

```

---
## ORB: Strategy Summary

::: {.columns}
::: {.column width="50%"}
**Strengths:**

- Consistent positive returns across most quarters
- Low turnover (controlled transaction costs)
- Clear entry/exit rules
- Adapts to volatility via ATR

**Key Observations:**

- Strategy performs well in trending markets
- ATR filter effectively reduces false breakouts
- Mean-reversion exit manages risk
:::

::: {.column width="50%"}
**Risk Management:**

- No overnight positions (flat at 15:40)
- One entry per day (prevents overtrading)
- Volatility-adjusted thresholds
- Excludes unreliable time windows

**Overall STAT Score:**

```{python}
#| echo: true
overall_stat = orb_port["stat"].sum()
print(f"Total STAT: {overall_stat:.4f}")
```
:::
:::

---

## Z Guided Trend: Strategy Summary

::: {.columns}
::: {.column width="50%"}
**Strengths:**

- Trend-aligned entries via fast/slow SMA filter
- Uses z-momentum confirmation to reduce early/late fades
- Intraday-only design (no overnight exposure)
- Works on both SP and NQ with the same logic

**Key Observations:**

- Best performance tends to occur in sustained intraday trends
- Z-momentum filter helps avoid entries on flattening/extreme z moves
- Cooldown reduces rapid flip-flopping after exits
:::

::: {.column width="50%"}
**Risk Management:**

- No trading during 09:31–09:55 (volatility buffer)
- No new entries after 14:30
- Forced flat from 15:40 onwards
- Stop-loss in z-space + extreme z exits
- Transaction costs included in net P&L

**Overall Net Performance (PORTFOLIO):**

```{python}
#| echo: true
import pandas as pd
from pathlib import Path

BASE_DIR = Path.cwd()
OUT_DIR  = BASE_DIR.parent / "Testing" / "outputs_strategy02"
perf = pd.read_csv(OUT_DIR / "strategy02_perf.csv")

port = perf[perf["asset"]=="PORTFOLIO"]
print(f"Total Net PnL: ${port['net_cumPnL'].sum():,.0f}")
print(f"Avg Net Sharpe (quarter avg): {port['netSR'].mean():.3f}")

```
:::
:::

---


## Conclusion & Next Steps

**Strategy 1 (ORB) Performance:**

```{python}
print(f"Total Net PnL: ${total_net_pnl:,.2f}")
print(f"Annualized Sharpe: {sharpe:.3f}")
print(f"Max Drawdown: ${max_dd:,.2f}")
print(f"Win Rate: {win_rate:.1f}%")
```
---

## Thank You

Questions?
